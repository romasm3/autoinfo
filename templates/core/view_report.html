{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ report.get_report_type_display }} Report - {{ report.vin }} | AutoInfo{% endblock %}

{% block content %}
<section style="padding: 2rem; background: #f5f5f5; min-height: 100vh;">
    <div class="container" style="max-width: 1400px; margin: 0 auto;">

        <!-- Back Button -->
        <a href="{% url 'dashboard' %}" style="display: inline-flex; align-items: center; gap: 0.5rem; color: #1E88E5; text-decoration: none; margin-bottom: 1.5rem; font-weight: 500; transition: all 0.3s;">
            <svg style="width: 20px; height: 20px; fill: currentColor;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back to Dashboard
        </a>

        <!-- Header Card -->
        <div style="background: linear-gradient(135deg, #1E88E5, #2196F3); color: white; padding: 2.5rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(30, 136, 229, 0.4);">
            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 2rem;">
                <div>
                    <h1 style="margin: 0 0 0.5rem 0; font-size: 2.5rem; font-weight: 700;">{{ report.get_report_type_display }} Report</h1>
                    <p style="margin: 0; opacity: 0.95; font-size: 1.1rem;">{{ report.vehicle_info }}</p>
                </div>
                <button onclick="window.print()" style="background: white; color: #1E88E5; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s;">
                    <svg style="width: 20px; height: 20px; fill: currentColor;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                    </svg>
                    Print Report
                </button>
            </div>

            <!-- Report Meta -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.3);">
                <div>
                    <div style="opacity: 0.85; font-size: 0.875rem; margin-bottom: 0.25rem;">VIN Number</div>
                    <div style="font-family: monospace; font-size: 1.2rem; font-weight: 600; letter-spacing: 0.5px;">{{ report.vin }}</div>
                </div>
                <div>
                    <div style="opacity: 0.85; font-size: 0.875rem; margin-bottom: 0.25rem;">Generated</div>
                    <div style="font-weight: 600; font-size: 1.1rem;">{{ report.created_at|date:"M d, Y H:i" }}</div>
                </div>
                <div>
                    <div style="opacity: 0.85; font-size: 0.875rem; margin-bottom: 0.25rem;">Price Paid</div>
                    <div style="font-weight: 700; font-size: 1.2rem;">{{ report.price_paid }} PLN</div>
                </div>
                {% if report.score %}
                <div>
                    <div style="opacity: 0.85; font-size: 0.875rem; margin-bottom: 0.25rem;">Score</div>
                    <div style="font-weight: 700; font-size: 1.2rem;">{{ report.score }}/100</div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if report.report_html %}
        <!-- ✅ FULL CARFAX/AUTOCHECK HTML REPORT FROM CHEAPCARFAX API -->
        <div style="background: white; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 2rem;">

            <!-- Report Container -->
            <div id="carfaxReportContainer" style="padding: 3rem; overflow-x: auto;">
                <!-- ✅ ČIA RODOMAS TIKRAS CARFAX/AUTOCHECK HTML IŠ CHEAPCARFAX API -->
                {{ report.report_html|safe }}
            </div>

        </div>

        {% else %}
        <!-- No HTML available -->
        <div style="background: white; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); padding: 3rem; text-align: center;">
            <div style="max-width: 600px; margin: 0 auto;">
                <svg style="width: 80px; height: 80px; fill: #ffc107; margin-bottom: 1.5rem;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <h2 style="color: #856404; margin-bottom: 1rem; font-size: 1.75rem;">Report Data Not Available</h2>
                <p style="color: #856404; margin-bottom: 2rem; font-size: 1.1rem; line-height: 1.6;">
                    The HTML report content is missing for this VIN.<br>
                    This may happen if the report was generated in demo mode or if there was an API error.
                </p>

                <!-- Quick Stats if available -->
                {% if report.score or report.accidents is not None or report.owners %}
                <div style="background: #f8f9fa; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: #212121;">Basic Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem;">
                        {% if report.score %}
                        <div style="text-align: center;">
                            <div style="font-size: 0.875rem; color: #757575; margin-bottom: 0.5rem;">Score</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #1E88E5;">{{ report.score }}<span style="font-size: 1rem; color: #757575;">/100</span></div>
                        </div>
                        {% endif %}
                        {% if report.accidents is not None %}
                        <div style="text-align: center;">
                            <div style="font-size: 0.875rem; color: #757575; margin-bottom: 0.5rem;">Accidents</div>
                            <div style="font-size: 2rem; font-weight: 700; color: {% if report.accidents == 0 %}#28a745{% else %}#dc3545{% endif %};">{{ report.accidents }}</div>
                        </div>
                        {% endif %}
                        {% if report.owners %}
                        <div style="text-align: center;">
                            <div style="font-size: 0.875rem; color: #757575; margin-bottom: 0.5rem;">Owners</div>
                            <div style="font-size: 2rem; font-weight: 700; color: {% if report.owners <= 2 %}#28a745{% else %}#ffc107{% endif %};">{{ report.owners }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <a href="{% url 'dashboard' %}" style="background: #1E88E5; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
                        Generate New Report
                    </a>
                    <a href="{% url 'contact' %}" style="background: white; color: #1E88E5; border: 2px solid #1E88E5; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
                        Contact Support
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
            <a href="{% url 'dashboard' %}" style="background: white; color: #1E88E5; border: 2px solid #1E88E5; padding: 0.75rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <svg style="width: 20px; height: 20px; fill: currentColor;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                Back to Dashboard
            </a>
        </div>

    </div>
</section>

<style>
/* ✅ Carfax/Autocheck HTML Styling */
#carfaxReportContainer {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    color: #333;
    line-height: 1.6;
}

#carfaxReportContainer table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    background: white;
}

#carfaxReportContainer th,
#carfaxReportContainer td {
    padding: 0.75rem 1rem;
    border: 1px solid #e0e0e0;
    text-align: left;
}

#carfaxReportContainer th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #212121;
}

#carfaxReportContainer img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1rem 0;
}

#carfaxReportContainer h1,
#carfaxReportContainer h2,
#carfaxReportContainer h3 {
    color: #212121;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

#carfaxReportContainer a {
    color: #1E88E5;
    text-decoration: none;
}

#carfaxReportContainer a:hover {
    text-decoration: underline;
}

/* Hover Effects */
a[href], button {
    transition: all 0.3s ease;
}

a[href]:hover, button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
}

/* Print Styling */
@media print {
    header, footer, button, a[href*="dashboard"], section > div > a {
        display: none !important;
    }

    body {
        background: white !important;
    }

    .container {
        max-width: 100% !important;
        padding: 0 !important;
    }

    section {
        padding: 0 !important;
        background: white !important;
    }

    #carfaxReportContainer {
        padding: 0 !important;
    }

    @page {
        margin: 1cm;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 1rem !important;
    }

    #carfaxReportContainer {
        padding: 1.5rem !important;
    }

    div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
}

/* Smooth scrolling */
html {
    scroll-behavior: smooth;
}
</style>

<script>
// Auto-scroll to report if HTML exists
document.addEventListener('DOMContentLoaded', function() {
    const reportContainer = document.getElementById('carfaxReportContainer');
    if (reportContainer && reportContainer.innerHTML.trim() !== '') {
        console.log('✅ Carfax HTML report loaded successfully');
    }
});

// Print button enhancement
window.addEventListener('beforeprint', function() {
    document.title = '{{ report.get_report_type_display }} Report - {{ report.vin }}';
});
</script>
{% endblock %}
